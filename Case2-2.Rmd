---
title: "Case Study 2, Pt. 2"
author: "Nathaniel Brown, In Hee Ho, Sarah Zimmermann"
date: "October 18, 2017"
output:
  html_document: default
  pdf_document: default
---

```{r, warning=FALSE, echo=FALSE, message=FALSE}
set.seed(440)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE)
library(ggplot2)
library(survival)
library(gridExtra)
library(dplyr)
library(survminer)
library(reshape2)
library(glmnet)
library(arm)
```

```{r, fig}
dat <- read.table("kellydat.txt", header=T)
dat$race = "Other"
dat$race[dat$black==1|dat$hisp==1 ]="Black or Hispanic"
dat$gender = "male"
dat$gender[dat$male==0]="female"
dat$symptom = "0"
dat$symptom[dat$sn1==1]="1"
dat$symptom[dat$sn2==1]="2"
dat$symptom[dat$sn3==1|dat$all4==1]="3+"
dat$scan="not scanned"
dat$scan[dat$fail==1]="scanned"
dat = dat %>% group_by(race) %>% mutate(racescan = ifelse(fail == 1, mean(fail), 1-mean(fail)))
dat = dat %>% group_by(symptom) %>% mutate(symptomscan = ifelse(fail == 1, mean(fail), 1-mean(fail)))
dat = dat %>% group_by(gender) %>% mutate(genderscan = ifelse(fail == 1, mean(fail), 1-mean(fail))) %>% as.data.frame()
```


#Introduction

The data are from a study of time to critical neurological assessment for patients with stroke-like symptoms who are admitted to the emergency room. We are interested in the factors predictive of the time to assessment following admission to the ED for n=335 patients with mild to moderate motor impairment. The goal of the analysis is to perform inferences on the impact of clinical presentation, gender, and race on time to neurological assessment, where clinical presentation is measured as the number of the four major stroke symptoms: headache, loss of motor skills or weakness, trouble talking or understanding, and vision problems.


###Kaplan-Meier Analysis for Race, Gender, and Clinical Presentation 

The first graph we created below is the overall survival curve. This curve shows how long the entire population in our dataset no matter the race, gender, or clinical condition will wait for evaluation. The graph also includes an upper and lower 95% confidence interval. Using this graph we know how the population is expected to wait. We can compare this estimated survival curve to the separate estimated survival curve for the different gender, race, and clincial condition groupings. 

```{r}
dat.KM <- survfit(Surv(nctdel, fail) ~ 1, data = dat) #estimated survival curve 

plot(dat.KM, main=expression(paste("Kaplan-Meier Estimate ", hat(S)(t), " with CI")),
     xlab="t", ylab="Survival", lwd=2)
```

```{r}

par(mfrow=c(1,3))
dat.KM.race <- survfit(Surv(nctdel, fail) ~ race, type="kaplan-meier", conf.type="log", data=dat)

plot(dat.KM.race, main=expression(paste("KM-Est ", hat(S)[g](t), " for Race")),
     xlab="t", ylab="Survival", lwd=2, col=1:3, cex.main=0.9)
legend(x="topright", col=1:2, lwd=2, legend=c("Black/Hisp", "Other"))


dat.KM.gender <- survfit(Surv(nctdel, fail) ~ male, type="kaplan-meier", conf.type="log", data=dat)

plot(dat.KM.gender, main=expression(paste("KM-Est ", hat(S)[g](t), " for Gender")),
     xlab="t", ylab="Survival", lwd=2, col=1:2, cex.main=0.9)
legend(x="topright", col=1:2, lwd=2, legend=c("male", "female"))


dat.KM.symptom <- survfit(Surv(nctdel, fail) ~ symptom, type="kaplan-meier", conf.type="log", data=dat)

plot(dat.KM.symptom, main=expression(paste("KM-Est ", hat(S)[g](t), " for Clinical Presentation")),
     xlab="t", ylab="Survival", lwd=2, col=1:4, cex.main=0.9)
legend(x="topright", col=1:4, lwd=2, legend=c("0", "1", "2", "3+"))


```

From our Kaplan-Meier estimates for three different variables (race, gender, and the number of major stroke symptoms a patient shows), we observe that the survival curves are generally similar between 0-5 minute time range. However, thereappears a difference between the estimated survival curves for different number of symptoms a patient shows; specifically, people showing more symptoms tend to wait a shorter amount of time for their treatment.

###Cox Proportional Hazard 

Below are models using Cox Proportional Hazard Model. This type of regression looks into the effects of variables upon the event in the data set which in this case is a CT scan. This model does assume the effects of the predictor variables upon survival are constant over time and are additive in one scale. We began by creating the models. They are Cox Ph models for waiting time until event (CT scan) based on gender (female vs male), race (black + hispanic vs non black + non hispanic), and number of symptoms (0,1,2, or 3+). Before analyzing any of these model we checked to see if the models are appropriate for the data by looking at the assumptions. Discussion is below.

####Model

```{r}
fitCPH_all<- coxph(Surv(nctdel, fail) ~ gender+race+symptom, data=dat)
```


####Diagnostics

Looking at the diagnostics for the model we will first investigate the residuals and then look into the influential points. If the model assumptions hold we will then look into the proportional hazard assumption before continuing on into a results analysis section. 

Looking at the residuals we see no pattern in the graph and a generally even spread number of points above and below 0. Since we see the residuals are independent of time.
```{r}
ggcoxdiagnostics(fitCPH_all, type = "deviance",
                 linear.predictions = FALSE, ggtheme = theme_bw(), main= "Residuals.") #residuals
```

Next, we investigate the influential points. For gender, although there are a few close to or above +/-.025 all of the points are below .05 so we do not consider any of the points influential. For race/ethnicity, looking into the influential points here, there are points as high as .04; however, again since there are no points are above/below .05 so we do not consider any of the points influential. Finally, for clinical presentation (0,1,2 or 3+ symptoms), looking into the influential points, there are different results. This time there are points as high as and higher than .05. Noticing this we accknowledge there are some points that will affect the fit of the model.

```{r}
ggcoxdiagnostics(fitCPH_all, type = "dfbeta",
                 linear.predictions = FALSE, ggtheme = theme_bw(),  main="Sympt. Influential Pts")#influential points
```


Finally we checked the assumption of proportional hazard using the cox.zph() function. We check to see if the test is statistically significance (p value under .05). Because none of the p values for the covariates are singificant we can assume the proportional hazards.

```{r}
cox.zph(fitCPH_all)
```

Since all of the assumptions of the Cox Proportional Hazard model are met. We continue with looking into the results of the model. 

####Results 

Looking at the summary of the model, we see if the patient is a male the wait time until CT scan will decrease by .1496 time units. If a patient is non black or non hispanic their wait time will increase by .1620. If a patient has 1 symptom they will wait .1724 longer than a patient with 0 symptoms. If a patient had 2 symptoms they wait  .1750 longer than a patient with 0 symptoms. Finally, a patient with 3+ symptoms will wait .3674 longer than a patient with no symptoms. We do note that non of the variables are significant predictors in the model. We also know the R squared value is .016 so 1.6% of the variance of the data is explained in the model.

Stepping back and reflecting, this model suggests there is gender bias against females, no race/ethnicity bias towards blacks and hispanics, and people with more than 0 symtoms have an longer wait time. Research shows that women tend to ignore signs of illness or attribute their symptoms of cardiac distress to something else (https://www.sharecare.com/health/womens-health/article/hidden-heart-attack-signs-in-women) so it is possible men will have a shorter wait time because they are more vocal about their signs of illness compared to women. Next, the data could have revealed occurance of racism during wait time meaning blacks and hispanic would wait longer, however this data does not show this is true. ***finish results section ***
```{r}
summary(fitCPH_all)
```


### Logistic Regression
```{r logit}

lower_bound <- function(x, bounds){
  ret <- rep(NA, length(x))
  for(i in 1:length(x)){
    xi <- x[i]
    found <- (which(xi >= c(-Inf, bounds) & (xi <= c(bounds, Inf))))[1] - 1
    if(found==0){found<-1}
    ret[i] <- bounds[found]
  }
  return(ret)
}

de_logit <- function(logodds){
  o <- exp(logodds)
  p <- o/(1+o)
  return(p)
}
bounds <- 1:5

dat$timecat <- as.integer(as.factor(lower_bound(dat$nctdel, bounds)))
dat$personid <- 1:nrow(dat)
datcat <- merge(dat$personid, bounds) %>% 
          unique() %>% 
          mutate(personid=x, timecat=as.integer(as.factor(y))) %>%
          arrange(personid, timecat) %>% 
            #take all unique combinations of people and time categories
          merge(dat, by=c("personid", "timecat"), all=TRUE) %>%
          mutate(fail = ifelse(is.na(fail), 0, fail)) %>%
            #add fail column
          group_by(personid) %>%
          mutate(maxtimecat = (timecat)[!is.na(nctdel)],
                 atrisk = (timecat <= maxtimecat)) %>%
          filter(atrisk) %>%
            #for each person, identify rows where persons are not at risk (after they fail/drop out), and remove those rows
          dplyr::select(personid, timecat, fail) %>%
          as.data.frame()

#code to add predictors of race, gender, and number of symptoms
datcat <- merge(datcat, dat, by="personid", all=T) %>% 
          mutate(symptom0 = ifelse(symptom == 0, 1, 0),
                 symptom1 = ifelse(symptom == 1, 1, 0),
                 symptom2 = ifelse(symptom == 2, 1, 0),
                 raceother = ifelse(race == "Other", 1, 0), 
                 male = ifelse(gender == "male", 1, 0), 
                 personid = as.integer(personid), 
                 timecat = as.integer(timecat.x), 
                 fail = as.integer(fail.x)) %>% 
          dplyr::select(personid, timecat = timecat, fail = fail, symptom0, symptom1, symptom2, raceother, male)

#code to add indicator effects of every timeunit
Xmat <- array(0, c(nrow(datcat), length(bounds)))
# previd <- NA
# changes <- c(diff(datcat$personid), 1) #a 1 marks the final index of each personid
# counts <- data.frame(x = datcat$personid) %>% group_by(x) %>% mutate(n=n()) %>% '[['("n")

for(r in 1:nrow(datcat)){
  Xmat[r,datcat$timecat[r]] <- 1
}

colnames(Xmat) <- paste0("X",1:ncol(Xmat))


datcat_X <- (cbind((datcat), Xmat))

nullmod <- glm(fail ~ 1, data=datcat_X, family="binomial")

logistic_diagnostics <- function(mod=NA, ydat=y, Xdat=X){
  
  if(class(mod) == "cv.glmnet"){
    fitvals <- predict.cv.glmnet(mod, newx = Xdat, s="lambda.min")
  }else{
    fitvals <- predict.glm(mod, newdata=data.frame(Xdat))
  }
  p_hat <- de_logit(fitvals)
  resids_p <- (ydat-p_hat)/(sqrt(p_hat*(1-p_hat)))
  s <- ydat; s[ydat==0] <- -1
  resids_d <- s*sqrt(-2*(ydat*log(p_hat) + (1-ydat)*log(1-p_hat)))
  resids_p_stat <- sum(resids_p^2)
  resids_d_stat <- -2*sum(ydat*log(p_hat) + (1-ydat)*log(1-p_hat))
  p <- sum(as.matrix(coef(mod)) != 0)
  dof <- nrow(Xdat)-p
  return(list(p_hat = p_hat, resids_p=resids_p, resids_p_stat=resids_p_stat, resids_d=resids_d, resids_d_stat=resids_d_stat, dof=dof))
}

indepcols <- which(!colnames(datcat_X) %in% c("fail", "personid", "timecat"))
X <- as.matrix(datcat_X[,indepcols])
y <- datcat_X$fail

#0 means no incercept
logmod <- glm(y ~ 0 + X, family="binomial")
logmod_stats <- logistic_diagnostics(logmod)
logmodtest <- pchisq(logmod$deviance, logmod$df.residual, lower=FALSE)

lassomod <- cv.glmnet(y=y, x = X, family="binomial", type.measure="class", alpha = 1, intercept=FALSE)
lassomod_stats <- logistic_diagnostics(lassomod)
lassomodtest <- pchisq(lassomod_stats$resids_d_stat, lassomod_stats$dof, lower=FALSE)

ridgemod <- cv.glmnet(y=y, x = X, family="binomial", type.measure="class", alpha = 0,intercept=FALSE)
ridgemod_stats <- logistic_diagnostics(ridgemod)
ridgemodtest <- pchisq(ridgemod_stats$resids_d_stat, ridgemod_stats$dof, lower=FALSE)


#evaluating deviance of models. small p-value = lack of fit
par((mfrow = c(3,1)))
binnedplot(x=logmod$fitted.values, y=logmod_stats$resids_d, main = "OLS Logistic Regression Binned Residuals", ylab = "Deviance Residuals", xlab = "Fitted Values")

binnedplot(x=lassomod_stats$p_hat, y=lassomod_stats$resids_d, main = "LASSO Logistic Regression Binned Residuals", ylab = "Deviance Residuals", xlab = "Fitted Values")

binnedplot(x=ridgemod_stats$p_hat, y=ridgemod_stats$resids_p, main = "Ridge Logistic Regression Binned Residuals", ylab = "Deviance Residuals", xlab = "Fitted Values")

```

To perform logistic regression on the data, we categorized the time to event variable into groups of **BLANK** minutes, with all events occuring after **BLANK** minutes representing one group, since the sample size was so lo after that time (only `r sum(dat$nctdel > 5)` observations). Our predictors of the response (treatment or censoring) consisted of these time categories, and categories of race (categorized as Black/Hispanic, and Other), gender (male or female), and number of sypmtoms (0, 1, 2, 3+). 

After performing logistic regression, we applied penalties to the regression because **BLANK**. LASSO Regularization has the best fit according to a deviance test, b. (the best fit depends on bin size and idk what bin size to use). The three p-values for the test are reported below:

```{r}
d <- matrix(c(logmodtest, lassomodtest, ridgemodtest))
colnames(d) <- "p-value"
rownames(d) <- c("Ordinary Least Squares", "LASSO Penalty", "Ridge Penalty")
knitr::kable(d)
```

The ridge looks like it has cleanest residuals (for now)
###Blah blah, more insights and p-values from logistic stuff. positive and negative coefficients.



#Contributions

Nathaniel built the logistic regression model. Sarah built and analyzed the Cox Proportional Hazard model. 



#References

http://influentialpoints.com/Training/coxs_proportional_hazards_modression_model-principles-properties-assumptions.htm#modmch


https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3059453/


http://dwoll.de/rexrepos/posts/survivalKM.html

http://www.sthda.com/english/wiki/cox-model-assumptions 


<!--
These are the assumptions for Cox regression according to the link: 

1.    The mechanisms giving rise to censoring of individuals must not be related to the probability of an event occurring. This assumption is known as non-informative censoring and applies for nearly all forms of survival analysis.

2.    Survival curves for different strata must have hazard functions that are proportional over time. This is the proportional hazards assumption discussed above for a single explanatory variable and for the multivariate model.

3.    There should be a linear relationship between the log hazard and each covariate. This is best checked using residual plots

-->
