---
title: "Case Study 2, Pt. 2"
author: "Nathaniel Brown, In Hee Ho, Sarah Zimmermann"
date: "October 18, 2017"
output:
  pdf_document: default
  html_document: default
---

<!-- 
PLANS:
  Sarah does cox thing
  
  Nathaniel does 

-->


```{r, warning=FALSE, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE)
library(ggplot2)
library(survival)
library(gridExtra)
library(dplyr)
library(survminer)
library(reshape2)
dat <- read.table("kellydat.txt", header=T)
library(glmnet)

```

```{r, fig}
dat <- read.table("kellydat.txt", header=T)
dat$race = "Other"
dat$race[dat$black==1|dat$hisp==1 ]="Black or Hispanic"
dat$gender = "male"
dat$gender[dat$male==0]="female"
dat$symptom = "0"
dat$symptom[dat$sn1==1]="1"
dat$symptom[dat$sn2==1]="2"
dat$symptom[dat$sn3==1|dat$all4==1]="3+"
dat$scan="not scanned"
dat$scan[dat$fail==1]="scanned"
dat = dat %>% group_by(race) %>% mutate(racescan = ifelse(fail == 1, mean(fail), 1-mean(fail)))
dat = dat %>% group_by(symptom) %>% mutate(symptomscan = ifelse(fail == 1, mean(fail), 1-mean(fail)))
dat = dat %>% group_by(gender) %>% mutate(genderscan = ifelse(fail == 1, mean(fail), 1-mean(fail))) %>% as.data.frame()
```

###Kaplan-Meier Analysis for Race, Gender, and Clinical Presentation 

```{r}
dat.KM <- survfit(Surv(nctdel, fail) ~ 1, data = dat) #estimated survival curve 

plot(dat.KM, main=expression(paste("Kaplan-Meier Estimate ", hat(S)(t), " with CI")),
     xlab="t", ylab="Survival", lwd=2)
```

```{r}

par(mfrow=c(1,3))
dat.KM.race <- survfit(Surv(nctdel, fail) ~ race, type="kaplan-meier", conf.type="log", data=dat)

plot(dat.KM.race, main=expression(paste("KM-Est ", hat(S)[g](t), " for Race")),
     xlab="t", ylab="Survival", lwd=2, col=1:3, cex.main=0.9)
legend(x="topright", col=1:2, lwd=2, legend=c("Black/Hisp", "Other"))


dat.KM.gender <- survfit(Surv(nctdel, fail) ~ male, type="kaplan-meier", conf.type="log", data=dat)

plot(dat.KM.gender, main=expression(paste("KM-Est ", hat(S)[g](t), " for Gender")),
     xlab="t", ylab="Survival", lwd=2, col=1:2, cex.main=0.9)
legend(x="topright", col=1:2, lwd=2, legend=c("male", "female"))


dat.KM.symptom <- survfit(Surv(nctdel, fail) ~ symptom, type="kaplan-meier", conf.type="log", data=dat)

plot(dat.KM.symptom, main=expression(paste("KM-Est ", hat(S)[g](t), " for Clinical Presentation")),
     xlab="t", ylab="Survival", lwd=2, col=1:4, cex.main=0.9)
legend(x="topright", col=1:4, lwd=2, legend=c("0", "1", "2", "3+"))


```


### Logistic Regression
```{r logit}

lower_bound <- function(x, bounds){
  ret <- rep(NA, length(x))
  for(i in 1:length(x)){
    xi <- x[i]
    found <- (which(xi >= c(-Inf, bounds) & (xi <= c(bounds, Inf))))[1] - 1
    if(found==0){found<-1}
    ret[i] <- bounds[found]
  }
  return(ret)
}

de_logit <- function(logodds){
  o <- exp(logodds)
  p <- o/(1+o)
  return(p)
}
bounds <- seq(0, floor(max(dat$nctdel)))

dat$timecat <- lower_bound(dat$nctdel, bounds)
dat$personid <- 1:nrow(dat)
datcat <- merge(dat$personid, bounds) %>% 
          unique() %>% 
          rename(personid=x, timecat=y) %>% 
          arrange(personid, timecat) %>% 
            #take all unique combinations of people and time categories
          merge(dat, by=c("personid", "timecat"), all=TRUE) %>%
          mutate(fail = ifelse(is.na(fail), 0, fail)) %>%
            #add fail column
          group_by(personid) %>%
          mutate(maxtimecat = (timecat)[!is.na(nctdel)],
                 atrisk = (timecat <= maxtimecat)) %>%
          filter(atrisk) %>%
            #for each person, identify rows where persons are not at risk (after they fail/drop out), and remove those rows
          select(personid, timecat, fail) %>%
          as.data.frame()

#code to add predictors of race, gender, and number of symptoms
datcat <- merge(datcat, dat, by="personid", all=T) %>% 
          mutate(symptom0 = ifelse(symptom == 0, 1, 0),
                 symptom1 = ifelse(symptom == 1, 1, 0),
                 symptom2 = ifelse(symptom == 2, 1, 0),
                 raceother = ifelse(race == "Other", 1, 0), 
                 male = ifelse(gender == "male", 1, 0), 
                 personid = as.integer(personid), 
                 timecat = as.integer(timecat.x), 
                 fail = as.integer(fail.x)) %>% 
          select(personid, timecat = timecat, fail = fail, symptom0, symptom1, symptom2, raceother, male)

#code to add indicator effects of every timeunit
Xmat <- array(0, c(nrow(datcat), length(bounds)))
# previd <- NA
# changes <- c(diff(datcat$personid), 1) #a 1 marks the final index of each personid
# counts <- data.frame(x = datcat$personid) %>% group_by(x) %>% mutate(n=n()) %>% '[['("n")

for(r in 1:nrow(datcat)){
  Xmat[r,datcat$timecat[r]+1] <- 1
}

colnames(Xmat) <- paste0("X",1:ncol(Xmat))


datcat_X <- (cbind((datcat), Xmat))

# ids <- c(229)
# dat %>% filter(personid %in% ids) %>% select(personid, timecat, fail)
# datcat %>% filter(personid %in% ids)

nullmod <- glm(fail ~ 1, data=datcat_X, family="binomial")

#0 means no incercept
logmod <- glm(fail ~ 0 + . - personid, data=datcat_X, family="binomial")
indepcols <- which(!colnames(datcat_X) %in% c("fail", "personid"))

X <- as.matrix(datcat_X[,indepcols])
y <- datcat_X$fail

regularization_diagnostics <- function(mod=NA, ydat=y, Xdat=X){

  p_hat <- de_logit(predict(mod, newx = Xdat, s="lambda.min"))
  resids_p <- (ydat-p_hat)/(sqrt(p_hat*(1-p_hat)))
  s <- ydat; s[ydat==0] <- -1
  resids_d <- s*sqrt(-2*(ydat*log(p_hat) + (1-ydat)*log(1-p_hat)))
  resids_p_stat <- sum(resids_p^2)
  resids_d_stat <- -2*sum(ydat*log(p_hat) + (1-ydat)*log(1-p_hat))
  p <- sum(as.matrix(coef(mod)) != 0)
  dof <- nrow(Xdat)-p
  return(list(p_hat = p_hat, resids_p=resids_p, resids_p_stat=resids_p_stat, resids_d=resids_d, resids_d_stat=resids_d_stat, dof=dof))
}

lassomod <- cv.glmnet(y=y, x = X, family="binomial", type.measure="class", alpha = 1)
lassomod_stats <- regularization_diagnostics(lassomod)

ridgemod <- cv.glmnet(y=y, x = X, family="binomial", type.measure="class", alpha = 0)
ridgemod_stats <- regularization_diagnostics(ridgemod, y, X)


#evaluating deviance of models. small p-value = lack of fit
logmodtest <- pchisq(logmod$deviance, logmod$df.residual, lower=FALSE)

lassomodtest <- pchisq(lassomod_stats$resids_d_stat, lassomod_stats$dof, lower=FALSE)

ridgemodtest <- pchisq(ridgemod_stats$resids_d_stat, ridgemod_stats$dof, lower=FALSE)

```

###Cox Proportional Hazard 

Below are models using Cox Proportional Hazard Model. This type of regression looks into the effects of variables upon the event in the data set which in this case is a CT scan. This model does assume the effects of the predictor variables upon survival are constant over time and are additive in one scale. We began by creating the models. The three listed below are the Cox Ph for waiting time until event (CT scan) based on gender (female vs male), race (black + hispanic vs non black + non hispanic), and number of symptoms (0,1,2, or 3+). Before analyzing any of these model we checked to see if the models are appropriate for the data by looking at the assumptions. Discussion is below. 
```{r}
fitCPH_gender<- coxph(Surv(nctdel, fail) ~ gender, data=dat)
fitCPH_race<- coxph(Surv(nctdel, fail) ~ race, data=dat)
fitCPH_symptom<- coxph(Surv(nctdel, fail) ~ symptom, data=dat)
```

####Gender

Looking at the diagnostics for the model gender influence on wait time to CT, we first investigated the influential points and then residuals of the graph. Although there are a few close to or above +/-.025 all of the points are below .05 so we do not consider any of the points influential. Additionally, looking at the residuals we see no pattern in the graph and a generally even spread number of points above and below 0. Since we see the residuals are independent of time. Finally we checked the assumption of proportional hazard. From the output, the test is not statistically significant (p=.447) for each of the covariates; therefore, we can assume the proportional hazards. 
```{r}
par(mfrow=c(1,2))

ggcoxdiagnostics(fitCPH_gender, type = "dfbeta",
                 linear.predictions = FALSE, ggtheme = theme_bw(), main="Gender Influential Pts")#influential points
ggcoxdiagnostics(fitCPH_gender, type = "deviance",
                 linear.predictions = FALSE, ggtheme = theme_bw(), main= "Gender Resids.") #residuals

cox.zph(fitCPH_gender)
```

####Race/Ethnicity 
Looking at the diagnostics for the model race/ethnicity influence on wait time to CT the results were very similar to the analysis for gender above. Looking into the influential points, there are points as high as .04; however, since there are no points are above/below .05 so we do not consider any of the points influential. Additionally, looking at the residuals we see no pattern in the graph and a generally even spread number of points above and below 0. Since we see the residuals are independent of time. Finally we checked the assumption of proportional hazard. From the output, the test is not statistically significant (p=.0802) for each of the covariates; therefore, we can assume the proportional hazards. 

```{r}
par(mfrow=c(1,2))

ggcoxdiagnostics(fitCPH_race, type = "dfbeta",
                 linear.predictions = FALSE, ggtheme = theme_bw(),  main="Race Influential Pts")#influential points
ggcoxdiagnostics(fitCPH_race, type = "deviance",
                 linear.predictions = FALSE, ggtheme = theme_bw(), main= "Race Resids.") #residuals
cox.zph(fitCPH_race)

```

####Clinical Presentation 

Looking at the diagnostics for the model clinical presentation influence on wait time to CT we do see different results than the results for gender and race/ethnicity above. Looking into the influential points, this time there are points as high as .05. We need to remove these points from the data since we consider these points affect the fit of the model. After removing the points  looking at the residuals we see no pattern in the graph and a generally even spread number of points above and below 0. Since we see the residuals are independent of time. Finally we checked the assumption of proportional hazard. From the output, the test is not statistically significant (p=.0802) for each of the covariates; therefore, we can assume the proportional hazards.

```{r}

par(mfrow=c(1,2))

ggcoxdiagnostics(fitCPH_symptom, type = "dfbeta",
                 linear.predictions = FALSE, ggtheme = theme_bw(),  main="Sympt. Influential Pts")#influential points

ggcoxdiagnostics(fitCPH_symptom, type = "deviance",
                 linear.predictions = FALSE, ggtheme = theme_bw(), main= "Sympt. Resids.") #residuals

cox.zph(fitCPH_symptom)
```


####Results 

Looking at the summary we see if the patient is a male the wait time until CT scan will decrease by .1499 time units; however, 
```{r}
summary(fitCPH_gender)
```

```{r}
summary(fitCPH_race)
```

```{r}
summary(fitCPH_symptom)
```






#References

http://influentialpoints.com/Training/coxs_proportional_hazards_modression_model-principles-properties-assumptions.htm#modmch


https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3059453/


http://dwoll.de/rexrepos/posts/survivalKM.html

http://www.sthda.com/english/wiki/cox-model-assumptions 


<!--
These are the assumptions for Cox regression according to the link: 

1.    The mechanisms giving rise to censoring of individuals must not be related to the probability of an event occurring. This assumption is known as non-informative censoring and applies for nearly all forms of survival analysis.

2.    Survival curves for different strata must have hazard functions that are proportional over time. This is the proportional hazards assumption discussed above for a single explanatory variable and for the multivariate model.

3.    There should be a linear relationship between the log hazard and each covariate. This is best checked using residual plots

-->
